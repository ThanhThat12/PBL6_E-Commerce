# ‚úÖ Cart Service & API - Fixed & Refactored

**Ng√†y:** 21/10/2025  
**Ng∆∞·ªùi th·ª±c hi·ªán:** GitHub Copilot + ThanhThat12  
**Tr·∫°ng th√°i:** ‚úÖ ƒê√£ ho√†n th√†nh

---

## üéØ V·∫•n ƒê·ªÅ Ban ƒê·∫ßu

### ‚ùå L·ªói Critical

```java
// CartService.java - L·ªñI
if (product.getStock() < quantity) {  // ‚ùå Product kh√¥ng c√≥ getStock()
    throw new RuntimeException("S·∫£n ph·∫©m kh√¥ng ƒë·ªß t·ªìn kho");
}
```

**Nguy√™n nh√¢n:**

- `Product` entity kh√¥ng c√≥ field `stock`
- Stock ch·ªâ t·ªìn t·∫°i trong `ProductVariant` entity
- CartItem ƒëang reference `Product` thay v√¨ `ProductVariant`
- CartController b·ªã comment to√†n b·ªô

---

## üîß C√°c Thay ƒê·ªïi ƒê√£ Th·ª±c Hi·ªán

### 1. **CartItem.java** - Changed Relationship

**Tr∆∞·ªõc:**

```java
@ManyToOne
@JoinColumn(name = "product_id")
private Product product;  // ‚ùå Sai
```

**Sau:**

```java
@ManyToOne
@JoinColumn(name = "product_variant_id")
private ProductVariant productVariant;  // ‚úÖ ƒê√∫ng
```

**L√Ω do:**

- Stock ƒë∆∞·ª£c qu·∫£n l√Ω ·ªü level ProductVariant, kh√¥ng ph·∫£i Product
- M·ªôt Product c√≥ nhi·ªÅu variants (m√†u, size...), m·ªói variant c√≥ stock ri√™ng

---

### 2. **CartItemRepository.java** - Updated Methods

**Tr∆∞·ªõc:**

```java
Optional<CartItem> findByCartAndProduct(Cart cart, Product product);
Optional<CartItem> findByCartIdAndProductId(Long cartId, Long productId);
```

**Sau:**

```java
Optional<CartItem> findByCartAndProductVariant(Cart cart, ProductVariant productVariant);
Optional<CartItem> findByCartIdAndProductVariantId(Long cartId, Long productVariantId);
```

---

### 3. **CartService.java** - Complete Refactor

**Thay ƒë·ªïi ch√≠nh:**

#### Dependency Injection

```java
// ‚ùå Tr∆∞·ªõc - Kh√¥ng c·∫ßn thi·∫øt
private final ProductRepository productRepository;
private final UserRepository userRepository;

// ‚úÖ Sau - Clean & focused
private final ProductVariantRepository productVariantRepository;
```

#### addToCart() Method

```java
// ‚úÖ Sau
public Cart addToCart(User user, Long productVariantId, int quantity) {
    ProductVariant productVariant = productVariantRepository.findById(productVariantId)
            .orElseThrow(() -> new RuntimeException("Product variant kh√¥ng t·ªìn t·∫°i"));

    // Ki·ªÉm tra t·ªìn kho t·ª´ ProductVariant
    if (productVariant.getStock() < quantity) {
        throw new RuntimeException("S·∫£n ph·∫©m kh√¥ng ƒë·ªß t·ªìn kho. T·ªìn kho hi·ªán t·∫°i: " + productVariant.getStock());
    }

    CartItem cartItem = cartItemRepository.findByCartAndProductVariant(cart, productVariant)
            .orElseGet(() -> {
                CartItem item = new CartItem();
                item.setCart(cart);
                item.setProductVariant(productVariant);  // ‚úÖ D√πng ProductVariant
                item.setQuantity(0);
                return item;
            });

    // ... rest of logic
}
```

#### C√°c methods kh√°c

- `updateQuantity()` - C·∫≠p nh·∫≠t v·ªõi productVariantId
- `removeFromCart()` - X√≥a v·ªõi productVariantId
- `clearCart()` - Kh√¥ng ƒë·ªïi
- `getCartItemCount()` - Kh√¥ng ƒë·ªïi

---

### 4. **DTOs M·ªõi** - Created 4 New DTOs

#### AddToCartRequest.java

```java
public class AddToCartRequest {
    private Long productVariantId;  // ‚úÖ D√πng productVariantId
    private int quantity;
}
```

#### UpdateCartQuantityRequest.java

```java
public class UpdateCartQuantityRequest {
    private int quantity;
}
```

#### CartItemResponseDTO.java

```java
public class CartItemResponseDTO {
    private Long id;
    private Long productVariantId;
    private String productName;
    private String productSku;
    private String productImage;
    private BigDecimal price;
    private Integer stock;
    private int quantity;
    private BigDecimal subtotal;  // ‚úÖ T√≠nh s·∫µn subtotal
}
```

#### CartResponseDTO.java

```java
public class CartResponseDTO {
    private Long cartId;
    private List<CartItemResponseDTO> items;
    private int totalItems;
    private BigDecimal totalAmount;  // ‚úÖ T·ªïng ti·ªÅn gi·ªè h√†ng
}
```

---

### 5. **CartController.java** - Completely Rewritten

**Tr∆∞·ªõc:** B·ªã comment to√†n b·ªô

**Sau:** 6 API endpoints ho√†n ch·ªânh

```java
@RestController
@RequestMapping("/api/cart")
public class CartController {
    // ... dependencies ...

    @PostMapping                              // Th√™m v√†o gi·ªè
    @GetMapping                               // Xem gi·ªè h√†ng
    @PutMapping("/{productVariantId}")        // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng
    @DeleteMapping("/{productVariantId}")     // X√≥a kh·ªèi gi·ªè
    @DeleteMapping("/clear")                  // X√≥a to√†n b·ªô gi·ªè
    @GetMapping("/count")                     // ƒê·∫øm s·ªë items
}
```

**Helper Methods:**

- `getCurrentUser()` - L·∫•y user t·ª´ SecurityContext
- `convertToCartResponseDTO()` - Convert Cart entity ‚Üí DTO v·ªõi t√≠nh to√°n subtotal & total

---

## üìã API Endpoints Chi Ti·∫øt

### 1. **POST /api/cart** - Th√™m v√†o gi·ªè h√†ng

**Request:**

```json
{
  "productVariantId": 1,
  "quantity": 2
}
```

**Response (Success):**

```json
{
  "code": 200,
  "error": null,
  "message": "ƒê√£ th√™m v√†o gi·ªè h√†ng",
  "data": "S·∫£n ph·∫©m ƒë√£ ƒë∆∞·ª£c th√™m v√†o gi·ªè h√†ng th√†nh c√¥ng"
}
```

**Response (Error - H·∫øt stock):**

```json
{
  "code": 400,
  "error": "S·ªë l∆∞·ª£ng v∆∞·ª£t qu√° t·ªìn kho. T·ªìn kho hi·ªán t·∫°i: 5",
  "message": "Th·∫•t b·∫°i",
  "data": null
}
```

---

### 2. **GET /api/cart** - Xem gi·ªè h√†ng

**Response:**

```json
{
  "code": 200,
  "error": null,
  "message": "L·∫•y gi·ªè h√†ng th√†nh c√¥ng",
  "data": {
    "cartId": 1,
    "items": [
      {
        "id": 1,
        "productVariantId": 5,
        "productName": "iPhone 15 Pro",
        "productSku": "IPH15-PRO-256-BLK",
        "productImage": "https://example.com/image.jpg",
        "price": 29990000,
        "stock": 10,
        "quantity": 2,
        "subtotal": 59980000
      }
    ],
    "totalItems": 2,
    "totalAmount": 59980000
  }
}
```

---

### 3. **PUT /api/cart/{productVariantId}** - C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng

**Request:**

```json
{
  "quantity": 5
}
```

**Response:**

```json
{
  "code": 200,
  "error": null,
  "message": "C·∫≠p nh·∫≠t th√†nh c√¥ng",
  "data": "S·ªë l∆∞·ª£ng s·∫£n ph·∫©m ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t"
}
```

---

### 4. **DELETE /api/cart/{productVariantId}** - X√≥a kh·ªèi gi·ªè

**Response:**

```json
{
  "code": 200,
  "error": null,
  "message": "X√≥a th√†nh c√¥ng",
  "data": "S·∫£n ph·∫©m ƒë√£ ƒë∆∞·ª£c x√≥a kh·ªèi gi·ªè h√†ng"
}
```

---

### 5. **DELETE /api/cart/clear** - X√≥a to√†n b·ªô gi·ªè

**Response:**

```json
{
  "code": 200,
  "error": null,
  "message": "X√≥a th√†nh c√¥ng",
  "data": "Gi·ªè h√†ng ƒë√£ ƒë∆∞·ª£c l√†m tr·ªëng"
}
```

---

### 6. **GET /api/cart/count** - ƒê·∫øm s·ªë items

**Response:**

```json
{
  "code": 200,
  "error": null,
  "message": "L·∫•y s·ªë l∆∞·ª£ng th√†nh c√¥ng",
  "data": 3
}
```

---

## üóÑÔ∏è Database Schema Changes

### cart_items Table - Column Change

**Tr∆∞·ªõc:**

```sql
CREATE TABLE cart_items (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    cart_id BIGINT,
    product_id BIGINT,  -- ‚ùå Sai
    quantity INT,
    FOREIGN KEY (cart_id) REFERENCES carts(id),
    FOREIGN KEY (product_id) REFERENCES products(id)  -- ‚ùå
);
```

**Sau:**

```sql
CREATE TABLE cart_items (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    cart_id BIGINT,
    product_variant_id BIGINT,  -- ‚úÖ ƒê√∫ng
    quantity INT,
    FOREIGN KEY (cart_id) REFERENCES carts(id),
    FOREIGN KEY (product_variant_id) REFERENCES product_variants(id)  -- ‚úÖ
);
```

**‚ö†Ô∏è Migration Required:**

```sql
-- N·∫øu c√≥ data c≈©, c·∫ßn migrate:
ALTER TABLE cart_items
    DROP FOREIGN KEY fk_cart_items_product;

ALTER TABLE cart_items
    CHANGE COLUMN product_id product_variant_id BIGINT;

ALTER TABLE cart_items
    ADD CONSTRAINT fk_cart_items_product_variant
    FOREIGN KEY (product_variant_id) REFERENCES product_variants(id);
```

---

## ‚úÖ Testing Checklist

### Unit Tests (Service Layer)

- [ ] CartService.addToCart() - Valid variant
- [ ] CartService.addToCart() - Out of stock
- [ ] CartService.addToCart() - Variant not found
- [ ] CartService.addToCart() - Add same variant twice (should update quantity)
- [ ] CartService.updateQuantity() - Valid update
- [ ] CartService.updateQuantity() - Exceed stock
- [ ] CartService.removeFromCart() - Valid removal
- [ ] CartService.clearCart() - Clear all items
- [ ] CartService.getCartItemCount() - Calculate total

### Integration Tests (Controller Layer)

- [ ] POST /api/cart - Success case
- [ ] POST /api/cart - Unauthorized (401)
- [ ] POST /api/cart - Out of stock (400)
- [ ] GET /api/cart - Empty cart
- [ ] GET /api/cart - Cart with items
- [ ] PUT /api/cart/{id} - Update quantity
- [ ] DELETE /api/cart/{id} - Remove item
- [ ] DELETE /api/cart/clear - Clear cart
- [ ] GET /api/cart/count - Count items

### Edge Cases

- [ ] Add to cart with quantity = 0
- [ ] Add to cart with negative quantity
- [ ] Update to quantity > stock
- [ ] Remove non-existent item
- [ ] Multiple concurrent add operations

---

## üîí Security & Authentication

**‚úÖ T·∫•t c·∫£ endpoints y√™u c·∫ßu authentication:**

- S·ª≠ d·ª•ng `SecurityContextHolder` ƒë·ªÉ l·∫•y user hi·ªán t·∫°i
- M·ªói user ch·ªâ xem/s·ª≠a ƒë∆∞·ª£c gi·ªè h√†ng c·ªßa m√¨nh
- Kh√¥ng th·ªÉ thao t√°c v·ªõi gi·ªè h√†ng c·ªßa user kh√°c

**Error Handling:**

- `RuntimeException("Ch∆∞a ƒëƒÉng nh·∫≠p")` n·∫øu kh√¥ng authenticated
- `RuntimeException("User kh√¥ng t·ªìn t·∫°i")` n·∫øu user kh√¥ng t√¨m th·∫•y trong DB

---

## üìä Performance Considerations

### Optimizations

1. ‚úÖ **Lazy Loading:** ProductVariant ‚Üí Product relation
2. ‚úÖ **Single Query:** findByCartAndProductVariant thay v√¨ 2 queries
3. ‚úÖ **Bulk Delete:** deleteByCartId() s·ª≠ d·ª•ng @Query

### Potential Improvements

- [ ] Add caching cho cart data (Redis)
- [ ] Batch operations cho multiple items
- [ ] Pagination cho cart items (n·∫øu cart r·∫•t l·ªõn)
- [ ] Add indexes: cart_id, product_variant_id

---

## üöÄ Next Steps

### Immediate (ƒê√£ xong)

- [x] Refactor CartItem entity
- [x] Update CartItemRepository
- [x] Refactor CartService
- [x] Create DTOs
- [x] Implement CartController
- [x] Test basic flow

### Short-term (C·∫ßn l√†m)

- [ ] Write unit tests
- [ ] Write integration tests
- [ ] Add validation annotations (@Valid, @Min, @Max)
- [ ] Add API documentation (Swagger annotations)
- [ ] Handle concurrent operations (optimistic locking)

### Long-term

- [ ] Implement cart expiration (auto-clear after X days)
- [ ] Add "Save for later" feature
- [ ] Implement cart sharing (send cart link)
- [ ] Add cart recommendations
- [ ] Implement guest cart (before login)

---

## üìù Notes & Best Practices

### Why ProductVariant instead of Product?

**Scenario:** iPhone 15 Pro c√≥ nhi·ªÅu variants:

- iPhone 15 Pro 256GB Black - Stock: 10
- iPhone 15 Pro 256GB White - Stock: 5
- iPhone 15 Pro 512GB Black - Stock: 3

N·∫øu d√πng `Product`:

- ‚ùå Kh√¥ng bi·∫øt user ch·ªçn m√†u/dung l∆∞·ª£ng n√†o
- ‚ùå Kh√¥ng bi·∫øt variant n√†o c√≤n stock
- ‚ùå Kh√¥ng t√≠nh ƒë√∫ng gi√° (variants c√≥ gi√° kh√°c nhau)

N·∫øu d√πng `ProductVariant`:

- ‚úÖ Bi·∫øt ch√≠nh x√°c variant user ch·ªçn
- ‚úÖ Check stock ch√≠nh x√°c
- ‚úÖ T√≠nh gi√° ch√≠nh x√°c
- ‚úÖ C√≥ th·ªÉ th√™m nhi·ªÅu variants kh√°c nhau v√†o cart

---

## üéØ Summary

**ƒê√£ fix:**

- ‚úÖ Product.getStock() error ‚Üí D√πng ProductVariant.getStock()
- ‚úÖ CartItem relationship ‚Üí Product ‚Üí ProductVariant
- ‚úÖ CartService logic ‚Üí Ho√†n to√†n refactored
- ‚úÖ CartController ‚Üí Uncommented & rewritten
- ‚úÖ DTOs ‚Üí Created 4 new DTOs
- ‚úÖ API endpoints ‚Üí 6 endpoints ƒë·∫ßy ƒë·ªß

**Files changed:**

1. CartItem.java
2. CartItemRepository.java
3. CartService.java
4. CartController.java
5. AddToCartRequest.java (new)
6. UpdateCartQuantityRequest.java (new)
7. CartItemResponseDTO.java (new)
8. CartResponseDTO.java (new)

**Compile status:** ‚úÖ No errors (IDE c√≥ th·ªÉ c·∫ßn reindex)

---

**T√°c gi·∫£:** GitHub Copilot + ThanhThat12  
**Ng√†y ho√†n th√†nh:** 21/10/2025  
**Review status:** üü° C·∫ßn test & review
