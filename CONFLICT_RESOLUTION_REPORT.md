# B√°o C√°o X·ª≠ L√Ω Conflict - Merge feature/auth-improvements v√†o main

**Ng√†y:** 21/10/2025  
**Ng∆∞·ªùi th·ª±c hi·ªán:** ThanhThat12  
**Nh√°nh ngu·ªìn:** `feature/auth-improvements`  
**Nh√°nh ƒë√≠ch:** `main`  
**Tr·∫°ng th√°i:** ‚úÖ ƒê√£ ho√†n th√†nh - T·∫•t c·∫£ conflicts ƒë√£ ƒë∆∞·ª£c gi·∫£i quy·∫øt

---

## üìã T·ªïng Quan

Trong qu√° tr√¨nh merge nh√°nh `feature/auth-improvements` v√†o `main`, ƒë√£ ph√°t sinh **6 file conflicts** c·∫ßn x·ª≠ l√Ω th·ªß c√¥ng. T·∫•t c·∫£ conflicts ƒë√£ ƒë∆∞·ª£c ph√¢n t√≠ch k·ªπ l∆∞·ª°ng v√† merge m·ªôt c√°ch h·ª£p l√Ω, k·∫øt h·ª£p t√≠nh nƒÉng t·ª´ c·∫£ hai nh√°nh.

---

## üî• Danh S√°ch Conflicts

| #   | File                          | Lo·∫°i Conflict | Tr·∫°ng th√°i  |
| --- | ----------------------------- | ------------- | ----------- |
| 1   | `JwtFilter.java`              | Deleted by us | ‚úÖ ƒê√£ x·ª≠ l√Ω |
| 2   | `SecurityConfig.java`         | Both modified | ‚úÖ ƒê√£ merge |
| 3   | `UserController.java`         | Both modified | ‚úÖ ƒê√£ merge |
| 4   | `VerificationRepository.java` | Both modified | ‚úÖ ƒê√£ merge |
| 5   | `UserService.java`            | Both modified | ‚úÖ ƒê√£ merge |
| 6   | `application.properties`      | Both modified | ‚úÖ ƒê√£ merge |

---

## üõ†Ô∏è Chi Ti·∫øt X·ª≠ L√Ω T·ª´ng Conflict

### 1. `JwtFilter.java` - DELETED ‚úÖ

**Conflict Type:** Deleted by us (feature branch)

**L√Ω do x√≥a:**

- File n√†y ƒë√£ ƒë∆∞·ª£c thay th·∫ø ho√†n to√†n b·∫±ng c∆° ch·∫ø OAuth2 Resource Server trong Spring Security 6.1+
- Kh√¥ng c√≤n c·∫ßn custom JWT filter v√¨ Spring Security t·ª± ƒë·ªông x·ª≠ l√Ω JWT token qua `JwtDecoder` bean

**Quy·∫øt ƒë·ªãnh:**

- ‚úÖ **X√ìA FILE** - X√°c nh·∫≠n x√≥a ho√†n to√†n b·∫±ng l·ªánh `git rm`

**L·ªánh th·ª±c thi:**

```bash
git rm Ecommerce/src/main/java/com/PBL6/Ecommerce/config/JwtFilter.java
```

---

### 2. `SecurityConfig.java` - MERGED ‚úÖ

**Conflict Type:** Both modified

**Nh√°nh `main` (HEAD):**

- CORS config c≈©: `.cors(cors -> cors.and())`
- Public endpoints gi·ªõi h·∫°n h∆°n (ch·ªâ `/api/auth/login`)

**Nh√°nh `feature/auth-improvements`:**

- CORS config m·ªõi: `.cors(cors -> cors.configure(http))` (Spring Security 6.1+)
- Public endpoints m·ªü r·ªông: th√™m `/api/auth/**`, `/api/products/**`, `/api/debug/**`
- OAuth2 resource server config c·∫£i thi·ªán

**Quy·∫øt ƒë·ªãnh merge:**

- ‚úÖ **CH·ªåN VERSION T·ª™ FEATURE** - V√¨ c√≥ c·∫•u h√¨nh hi·ªán ƒë·∫°i v√† ƒë·∫ßy ƒë·ªß h∆°n
- Gi·ªØ c√∫ ph√°p CORS m·ªõi (Spring Security 6.1+)
- Gi·ªØ public endpoints m·ªü r·ªông ƒë·ªÉ h·ªó tr·ª£ debug v√† products API
- Gi·ªØ OAuth2 resource server config c·∫£i thi·ªán

**K·∫øt qu·∫£:**

```java
.cors(cors -> cors.configure(http))
.requestMatchers(
    "/api/auth/**",
    "/api/register/**",
    "/api/forgot-password/**",
    "/api/authenticate",
    "/api/authenticate/**",
    "/api/products/**",
    "/api/debug/**"
).permitAll()
```

---

### 3. `UserController.java` - MERGED ‚úÖ

**Conflict Type:** Both modified

**Nh√°nh `main` (HEAD):**

- C√≥ ƒë·∫ßy ƒë·ªß **Admin APIs** (getUsersByRole, updateUserRole, updateUserStatus, deleteUser)
- Import `@PreAuthorize` ƒë·ªÉ ki·ªÉm so√°t quy·ªÅn
- Import `AdminUserDetailDTO` cho admin user detail

**Nh√°nh `feature/auth-improvements`:**

- C√≥ **Rate limiting logic** (LoginAttemptService integration)
- C√≥ helper method `getClientIp()` ƒë·ªÉ l·∫•y IP t·ª´ proxies
- Import `HttpServletRequest` v√† `jakarta.servlet.*`

**Quy·∫øt ƒë·ªãnh merge:**

- ‚úÖ **K·∫æT H·ª¢P C·∫¢ HAI** - Merge t·∫•t c·∫£ t√≠nh nƒÉng t·ª´ c·∫£ 2 nh√°nh
- Gi·ªØ Admin APIs t·ª´ `main`
- Gi·ªØ Rate limiting logic t·ª´ `feature/auth-improvements`
- Th√™m method `getClientIp()` ƒë·ªÉ h·ªó tr·ª£ rate limiting

**Imports ƒë√£ merge:**

```java
import org.springframework.security.access.prepost.PreAuthorize;
import jakarta.servlet.http.HttpServletRequest;
import com.PBL6.Ecommerce.domain.dto.AdminUserDetailDTO;
import com.PBL6.Ecommerce.service.LoginAttemptService;
```

**T√≠nh nƒÉng ch√≠nh:**

- ‚úÖ Admin APIs (GET users by role, UPDATE role/status, DELETE user)
- ‚úÖ Rate limiting cho register endpoints
- ‚úÖ IP extraction t·ª´ proxies (X-Forwarded-For, X-Real-IP)

---

### 4. `VerificationRepository.java` - MERGED ‚úÖ

**Conflict Type:** Both modified (duplicate imports)

**V·∫•n ƒë·ªÅ:**

- Import `java.time.LocalDateTime` b·ªã tr√πng l·∫∑p
- Import `java.util.Optional` b·ªã tr√πng l·∫∑p

**Quy·∫øt ƒë·ªãnh merge:**

- ‚úÖ **G·ªòP IMPORTS** - Lo·∫°i b·ªè import tr√πng l·∫∑p
- S·∫Øp x·∫øp imports theo th·ª© t·ª± chu·∫©n Java

**K·∫øt qu·∫£:**

```java
import java.time.LocalDateTime;
import java.util.List;
import java.util.Optional;

import org.springframework.data.jpa.repository.JpaRepository;
...
```

---

### 5. `UserService.java` - MERGED ‚úÖ

**Conflict Type:** Both modified (most complex)

**Nh√°nh `main` (HEAD):**

- C√≥ **Admin services** (getUsersByRole, updateUserRole, updateUserStatus, deleteUser)
- C√≥ dependency injection cho Cart, Shop, Product repositories
- C√≥ imports cho admin DTOs (ListAdminUserDTO, AdminUserDetailDTO, etc.)

**Nh√°nh `feature/auth-improvements`:**

- C√≥ **Rate limiting integration** (LoginAttemptService)
- C√≥ **OTP security features** (failed attempts, locked OTP, used OTP)
- C√≥ **ConcurrentHashMap** ƒë·ªÉ tr√°nh race condition khi t·∫°o OTP

**Quy·∫øt ƒë·ªãnh merge:**

- ‚úÖ **K·∫æT H·ª¢P T·∫§T C·∫¢ DEPENDENCIES** - Merge constructor v·ªõi ƒë·∫ßy ƒë·ªß dependencies
- Gi·ªØ admin logic t·ª´ `main`
- Gi·ªØ rate limiting v√† OTP security t·ª´ `feature/auth-improvements`

**Constructor ƒë√£ merge:**

```java
public UserService(
    UserRepository userRepository,
    VerificationRepository verificationRepository,
    PasswordEncoder passwordEncoder,
    EmailService emailService,
    SmsService smsService,
    LoginAttemptService loginAttemptService,     // ‚Üê From feature
    CartRepository cartRepository,                // ‚Üê From main
    CartItemRepository cartItemRepository,        // ‚Üê From main
    ShopRepository shopRepository,                // ‚Üê From main
    ProductRepository productRepository           // ‚Üê From main
)
```

**Imports ƒë√£ merge:**

```java
// Admin related (from main)
import com.PBL6.Ecommerce.domain.Cart;
import com.PBL6.Ecommerce.domain.Shop;
import com.PBL6.Ecommerce.domain.dto.AdminUserDetailDTO;
import com.PBL6.Ecommerce.domain.dto.ListAdminUserDTO;
import com.PBL6.Ecommerce.domain.dto.ListCustomerUserDTO;
import com.PBL6.Ecommerce.domain.dto.ListSellerUserDTO;
import com.PBL6.Ecommerce.repository.CartRepository;
import com.PBL6.Ecommerce.repository.CartItemRepository;
import com.PBL6.Ecommerce.repository.ProductRepository;
import com.PBL6.Ecommerce.repository.ShopRepository;

// Security & rate limiting (from feature)
import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.ConcurrentMap;
```

**T√≠nh nƒÉng ch√≠nh:**

- ‚úÖ OTP verification v·ªõi rate limiting
- ‚úÖ OTP security (failed attempts, locked, used status)
- ‚úÖ Admin user management
- ‚úÖ Delete user with cascading (cart, shop, products)

---

### 6. `application.properties` - MERGED ‚úÖ

**Conflict Type:** Both modified

**Nh√°nh `main` (HEAD):**

- `server.port=8081`
- `spring.datasource.url=jdbc:mysql://localhost:3306/ecommerce1`
- `spring.datasource.password=` (empty)
- C√≥ Twilio config

**Nh√°nh `feature/auth-improvements`:**

- `server.port=8080`
- `spring.datasource.url=jdbc:mysql://localhost:3306/ecommerce_db`
- C√≥ JWT config v·ªõi secret key v√† expiration
- C√≥ Refresh token config

**Quy·∫øt ƒë·ªãnh merge:**

- ‚úÖ **∆ØU TI√äN MAIN CHO DATABASE** - Gi·ªØ database settings t·ª´ `main` (ecommerce1, port 8081)
- ‚úÖ **TH√äM JWT & REFRESH TOKEN CONFIG** t·ª´ feature - C·∫ßn thi·∫øt cho authentication improvements

**K·∫øt qu·∫£ merged:**

```properties
# Database (from main)
server.port=8081
spring.datasource.url=jdbc:mysql://localhost:3306/ecommerce1
spring.datasource.password=

# JWT & Refresh Token (from feature) - NEW!
jwt.secret=${JWT_SECRET_KEY:my-secret-key-which-should-be-long-and-secure-at-least-32-chars}
jwt.expiration=3600000
refresh.token.expiration=604800000

# Twilio (from main)
twilio.accountSid=
twilio.authToken=
twilio.phoneNumber=
```

---

## üö® L∆∞u √ù Quan Tr·ªçng

### ‚ö†Ô∏è UserInfoDTO Constructor Issue

**V·∫•n ƒë·ªÅ ph√°t hi·ªán:**

- M·ªôt s·ªë n∆°i trong code g·ªçi `UserInfoDTO(Long, String, String, String)` v·ªõi **4 parameters**
- Nh∆∞ng constructor hi·ªán t·∫°i y√™u c·∫ßu **5 parameters**: `(Long id, String email, String username, String phoneNumber, String role)`

**V·ªã tr√≠ l·ªói:**

1. `UserService.java` line 294: `getUsersByRole()` method
2. `UserService.java` line 485: `updateUserRole()` method
3. `UserService.java` line 509: `updateUserStatus()` method

**C·∫ßn x·ª≠ l√Ω:**

```java
// ‚ùå SAI - thi·∫øu phoneNumber parameter
new UserInfoDTO(user.getId(), user.getEmail(), user.getUsername(), user.getRole().name())

// ‚úÖ ƒê√öNG - ƒë·∫ßy ƒë·ªß 5 parameters
new UserInfoDTO(user.getId(), user.getEmail(), user.getUsername(), user.getPhoneNumber(), user.getRole().name())
```

**H√†nh ƒë·ªông ti·∫øp theo:**

- [ ] S·ª≠a t·∫•t c·∫£ 3 v·ªã tr√≠ g·ªçi constructor `UserInfoDTO` th√™m parameter `user.getPhoneNumber()`

---

## ‚úÖ K·∫øt Qu·∫£ Merge

### Files Changed Summary

**Deleted:**

- `JwtFilter.java` (replaced by OAuth2 resource server)

**Modified:**

- `SecurityConfig.java` - Modern CORS config + extended public endpoints
- `UserController.java` - Admin APIs + Rate limiting
- `VerificationRepository.java` - Clean imports
- `UserService.java` - Admin services + OTP security + Rate limiting
- `application.properties` - JWT config + Refresh token config

**New Files Added** (from feature branch):

- `LoginAttemptService.java` - Rate limiting service
- `RefreshTokenService.java` - Token rotation service
- `TokenBlacklistService.java` - Logout functionality
- `TokenCleanupScheduler.java` - Scheduled cleanup
- `RefreshToken.java` - Domain entity
- `AuthTokenResponse.java` - DTO for token response
- `RefreshTokenRequest.java` - DTO for refresh request
- `LogoutController.java` - Logout endpoint
- `RefreshTokenController.java` - Token refresh endpoint

---

## üéØ Chi·∫øn L∆∞·ª£c Merge

**Nguy√™n t·∫Øc √°p d·ª•ng:**

1. **∆Øu ti√™n t√≠nh nƒÉng m·ªõi** - Gi·ªØ authentication improvements t·ª´ feature branch
2. **B·∫£o to√†n admin features** - Gi·ªØ nguy√™n admin management t·ª´ main
3. **K·∫øt h·ª£p dependencies** - Merge t·∫•t c·∫£ services/repositories c·∫ßn thi·∫øt
4. **Chu·∫©n h√≥a code** - Lo·∫°i b·ªè duplicate imports, fix formatting

**Chi·∫øn thu·∫≠t:**

- V·ªõi **JwtFilter**: X√ìA (kh√¥ng c√≤n d√πng)
- V·ªõi **SecurityConfig**: CH·ªåN feature (modern config)
- V·ªõi **UserController**: MERGE C·∫¢ HAI (admin + rate limiting)
- V·ªõi **UserService**: MERGE C·∫¢ HAI (admin + security)
- V·ªõi **application.properties**: MERGE C·∫¢ HAI (database from main + JWT from feature)

---

## üìù H√†nh ƒê·ªông Ti·∫øp Theo

### C·∫ßn l√†m ngay:

1. **S·ª≠a UserInfoDTO constructor calls** ‚ö†Ô∏è QUAN TR·ªåNG

   ```java
   // T√¨m v√† thay th·∫ø t·∫•t c·∫£
   new UserInfoDTO(id, email, username, role)
   // Th√†nh
   new UserInfoDTO(id, email, username, phoneNumber, role)
   ```

2. **Compile v√† test project**

   ```bash
   ./mvnw clean compile
   ./mvnw test
   ```

3. **Ki·ªÉm tra integration**

   - Test login/logout flow
   - Test refresh token flow
   - Test admin APIs
   - Test rate limiting

4. **Commit merge**

   ```bash
   git commit -m "Merge feature/auth-improvements into main

   - Resolved 6 file conflicts
   - Removed deprecated JwtFilter (replaced by OAuth2 resource server)
   - Merged SecurityConfig with modern CORS and extended public endpoints
   - Merged UserController with admin APIs and rate limiting
   - Merged UserService with admin services and OTP security
   - Updated application.properties with JWT and refresh token config

   Features added:
   - JWT authentication with refresh token rotation
   - Rate limiting for OTP and registration
   - Token blacklist for secure logout
   - OTP security (failed attempts, locked status)
   - Scheduled token cleanup

   Admin features preserved:
   - User management by role (admin/seller/buyer)
   - Update user role and status
   - Delete user with cascading cleanup"
   ```

---

## üìä Th·ªëng K√™

- **T·ªïng s·ªë conflicts:** 6
- **Conflicts resolved:** 6 (100%)
- **Files deleted:** 1
- **Files modified:** 5
- **New files added:** ~15+
- **Th·ªùi gian x·ª≠ l√Ω:** ~30 ph√∫t

---

## ‚úçÔ∏è T√°c Gi·∫£ & X√°c Nh·∫≠n

**Ng∆∞·ªùi th·ª±c hi·ªán:** ThanhThat12  
**Reviewer:** (C·∫ßn review)  
**Ng√†y ho√†n th√†nh:** 21/10/2025  
**Tr·∫°ng th√°i:** ‚úÖ Ready for commit (sau khi fix UserInfoDTO constructor)

---

## üîó T√†i Li·ªáu Li√™n Quan

- [AUTH_IMPROVEMENTS_REPORT.md](AUTH_IMPROVEMENTS_REPORT.md) - Chi ti·∫øt t√≠nh nƒÉng authentication improvements
- [RESTRUCTURING_PROPOSAL.md](RESTRUCTURING_PROPOSAL.md) - ƒê·ªÅ xu·∫•t c·∫£i thi·∫øn c·∫•u tr√∫c code

---

## üîÑ H∆∞·ªõng D·∫´n Refactoring (N·∫øu √Åp D·ª•ng)

### üìã **T·ªïng Quan Chi·∫øn L∆∞·ª£c**

Sau khi merge th√†nh c√¥ng, n·∫øu quy·∫øt ƒë·ªãnh refactor sang **Feature/Module-based Architecture**, ƒë√¢y l√† c√°c thay ƒë·ªïi c·∫ßn √°p d·ª•ng cho t·ª´ng file ƒë√£ merge:

---

### **Phase 1: Refactor Cart Module (ƒê∆°n gi·∫£n nh·∫•t - B·∫Øt ƒë·∫ßu t·ª´ ƒë√¢y)**

#### 1.1. CartController.java
**From:** `controller/CartController.java`  
**To:** `cart/controller/CartController.java`

```bash
# T·∫°o c·∫•u tr√∫c m·ªõi
mkdir -p Ecommerce/src/main/java/com/PBL6/Ecommerce/cart/controller
mkdir -p Ecommerce/src/main/java/com/PBL6/Ecommerce/cart/service
mkdir -p Ecommerce/src/main/java/com/PBL6/Ecommerce/cart/domain
mkdir -p Ecommerce/src/main/java/com/PBL6/Ecommerce/cart/repository
mkdir -p Ecommerce/src/main/java/com/PBL6/Ecommerce/cart/dto

# Di chuy·ªÉn files
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/controller/CartController.java Ecommerce/src/main/java/com/PBL6/Ecommerce/cart/controller/
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/service/CartService.java Ecommerce/src/main/java/com/PBL6/Ecommerce/cart/service/
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/domain/Cart.java Ecommerce/src/main/java/com/PBL6/Ecommerce/cart/domain/
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/domain/CartItem.java Ecommerce/src/main/java/com/PBL6/Ecommerce/cart/domain/
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/repository/CartRepository.java Ecommerce/src/main/java/com/PBL6/Ecommerce/cart/repository/
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/repository/CartItemRepository.java Ecommerce/src/main/java/com/PBL6/Ecommerce/cart/repository/

# Di chuy·ªÉn DTOs
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/domain/dto/AddToCartRequest.java Ecommerce/src/main/java/com/PBL6/Ecommerce/cart/dto/
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/domain/dto/UpdateCartQuantityRequest.java Ecommerce/src/main/java/com/PBL6/Ecommerce/cart/dto/
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/domain/dto/CartItemResponseDTO.java Ecommerce/src/main/java/com/PBL6/Ecommerce/cart/dto/
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/domain/dto/CartResponseDTO.java Ecommerce/src/main/java/com/PBL6/Ecommerce/cart/dto/
```

**Thay ƒë·ªïi package trong files:**

```java
// CartController.java - C·∫≠p nh·∫≠t package v√† imports
package com.PBL6.Ecommerce.cart.controller;

import com.PBL6.Ecommerce.cart.domain.Cart;
import com.PBL6.Ecommerce.cart.domain.CartItem;
import com.PBL6.Ecommerce.cart.dto.AddToCartRequest;
import com.PBL6.Ecommerce.cart.dto.CartItemResponseDTO;
import com.PBL6.Ecommerce.cart.dto.CartResponseDTO;
import com.PBL6.Ecommerce.cart.dto.UpdateCartQuantityRequest;
import com.PBL6.Ecommerce.cart.service.CartService;
import com.PBL6.Ecommerce.common.dto.ResponseDTO; // ‚Üê Shared DTO
import com.PBL6.Ecommerce.user.domain.User;        // ‚Üê User t·ª´ user module
import com.PBL6.Ecommerce.user.repository.UserRepository;
// ... rest of imports
```

**C·∫•u tr√∫c Cart Module sau refactor:**
```
cart/
‚îú‚îÄ‚îÄ controller/
‚îÇ   ‚îî‚îÄ‚îÄ CartController.java           ‚Üê API endpoints
‚îú‚îÄ‚îÄ service/
‚îÇ   ‚îî‚îÄ‚îÄ CartService.java               ‚Üê Business logic
‚îú‚îÄ‚îÄ domain/
‚îÇ   ‚îú‚îÄ‚îÄ Cart.java                      ‚Üê Entity
‚îÇ   ‚îî‚îÄ‚îÄ CartItem.java                  ‚Üê Entity
‚îú‚îÄ‚îÄ repository/
‚îÇ   ‚îú‚îÄ‚îÄ CartRepository.java            ‚Üê Data access
‚îÇ   ‚îî‚îÄ‚îÄ CartItemRepository.java        ‚Üê Data access
‚îî‚îÄ‚îÄ dto/
    ‚îú‚îÄ‚îÄ AddToCartRequest.java          ‚Üê Request DTO
    ‚îú‚îÄ‚îÄ UpdateCartQuantityRequest.java ‚Üê Request DTO
    ‚îú‚îÄ‚îÄ CartItemResponseDTO.java       ‚Üê Response DTO
    ‚îî‚îÄ‚îÄ CartResponseDTO.java           ‚Üê Response DTO
```

---

### **Phase 2: Refactor Security Module (Authentication - Files ƒë√£ merge)**

#### 2.1. SecurityConfig.java
**From:** `config/SecurityConfig.java`  
**To:** `security/config/SecurityConfig.java`

```bash
# T·∫°o c·∫•u tr√∫c Security module
mkdir -p Ecommerce/src/main/java/com/PBL6/Ecommerce/security/config
mkdir -p Ecommerce/src/main/java/com/PBL6/Ecommerce/security/controller
mkdir -p Ecommerce/src/main/java/com/PBL6/Ecommerce/security/service
mkdir -p Ecommerce/src/main/java/com/PBL6/Ecommerce/security/domain
mkdir -p Ecommerce/src/main/java/com/PBL6/Ecommerce/security/repository
mkdir -p Ecommerce/src/main/java/com/PBL6/Ecommerce/security/dto
mkdir -p Ecommerce/src/main/java/com/PBL6/Ecommerce/security/util

# Di chuy·ªÉn Config
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/config/SecurityConfig.java Ecommerce/src/main/java/com/PBL6/Ecommerce/security/config/
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/config/WebConfig.java Ecommerce/src/main/java/com/PBL6/Ecommerce/security/config/

# Di chuy·ªÉn Controllers (t·ª´ files ƒë√£ merge)
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/controller/AuthController.java Ecommerce/src/main/java/com/PBL6/Ecommerce/security/controller/
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/controller/GoogleAuthController.java Ecommerce/src/main/java/com/PBL6/Ecommerce/security/controller/
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/controller/FacebookAuthController.java Ecommerce/src/main/java/com/PBL6/Ecommerce/security/controller/
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/controller/RefreshTokenController.java Ecommerce/src/main/java/com/PBL6/Ecommerce/security/controller/
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/controller/LogoutController.java Ecommerce/src/main/java/com/PBL6/Ecommerce/security/controller/

# Di chuy·ªÉn Services (t·ª´ files ƒë√£ merge)
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/service/AuthService.java Ecommerce/src/main/java/com/PBL6/Ecommerce/security/service/
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/service/GoogleAuthService.java Ecommerce/src/main/java/com/PBL6/Ecommerce/security/service/
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/service/FacebookAuthService.java Ecommerce/src/main/java/com/PBL6/Ecommerce/security/service/
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/service/RefreshTokenService.java Ecommerce/src/main/java/com/PBL6/Ecommerce/security/service/
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/service/TokenBlacklistService.java Ecommerce/src/main/java/com/PBL6/Ecommerce/security/service/
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/service/LoginAttemptService.java Ecommerce/src/main/java/com/PBL6/Ecommerce/security/service/
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/service/TokenCleanupScheduler.java Ecommerce/src/main/java/com/PBL6/Ecommerce/security/service/

# Di chuy·ªÉn Domain entities
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/domain/RefreshToken.java Ecommerce/src/main/java/com/PBL6/Ecommerce/security/domain/
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/domain/Verification.java Ecommerce/src/main/java/com/PBL6/Ecommerce/security/domain/

# Di chuy·ªÉn Repositories (t·ª´ files ƒë√£ merge)
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/repository/RefreshTokenRepository.java Ecommerce/src/main/java/com/PBL6/Ecommerce/security/repository/
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/repository/VerificationRepository.java Ecommerce/src/main/java/com/PBL6/Ecommerce/security/repository/

# Di chuy·ªÉn DTOs (Auth-related)
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/domain/dto/LoginDTO.java Ecommerce/src/main/java/com/PBL6/Ecommerce/security/dto/
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/domain/dto/GoogleLoginDTO.java Ecommerce/src/main/java/com/PBL6/Ecommerce/security/dto/
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/domain/dto/FacebookLoginDTO.java Ecommerce/src/main/java/com/PBL6/Ecommerce/security/dto/
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/domain/dto/AuthTokenResponse.java Ecommerce/src/main/java/com/PBL6/Ecommerce/security/dto/
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/domain/dto/RefreshTokenRequest.java Ecommerce/src/main/java/com/PBL6/Ecommerce/security/dto/
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/domain/dto/JwtResponse.java Ecommerce/src/main/java/com/PBL6/Ecommerce/security/dto/

# Di chuy·ªÉn Utilities
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/util/TokenProvider.java Ecommerce/src/main/java/com/PBL6/Ecommerce/security/util/
```

**Thay ƒë·ªïi package trong SecurityConfig.java:**

```java
package com.PBL6.Ecommerce.security.config;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
// ... rest of imports

@Configuration
public class SecurityConfig {
    // ... (gi·ªØ nguy√™n logic ƒë√£ merge)
}
```

**C·∫•u tr√∫c Security Module sau refactor:**
```
security/
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îú‚îÄ‚îÄ SecurityConfig.java            ‚Üê ƒê√£ merge (CORS + OAuth2)
‚îÇ   ‚îî‚îÄ‚îÄ WebConfig.java
‚îú‚îÄ‚îÄ controller/
‚îÇ   ‚îú‚îÄ‚îÄ AuthController.java
‚îÇ   ‚îú‚îÄ‚îÄ GoogleAuthController.java
‚îÇ   ‚îú‚îÄ‚îÄ FacebookAuthController.java
‚îÇ   ‚îú‚îÄ‚îÄ RefreshTokenController.java    ‚Üê T·ª´ feature branch
‚îÇ   ‚îî‚îÄ‚îÄ LogoutController.java          ‚Üê T·ª´ feature branch
‚îú‚îÄ‚îÄ service/
‚îÇ   ‚îú‚îÄ‚îÄ AuthService.java
‚îÇ   ‚îú‚îÄ‚îÄ GoogleAuthService.java
‚îÇ   ‚îú‚îÄ‚îÄ FacebookAuthService.java
‚îÇ   ‚îú‚îÄ‚îÄ RefreshTokenService.java       ‚Üê T·ª´ feature branch
‚îÇ   ‚îú‚îÄ‚îÄ TokenBlacklistService.java     ‚Üê T·ª´ feature branch
‚îÇ   ‚îú‚îÄ‚îÄ LoginAttemptService.java       ‚Üê T·ª´ feature branch (Rate limiting)
‚îÇ   ‚îî‚îÄ‚îÄ TokenCleanupScheduler.java     ‚Üê T·ª´ feature branch
‚îú‚îÄ‚îÄ domain/
‚îÇ   ‚îú‚îÄ‚îÄ RefreshToken.java              ‚Üê T·ª´ feature branch
‚îÇ   ‚îî‚îÄ‚îÄ Verification.java
‚îú‚îÄ‚îÄ repository/
‚îÇ   ‚îú‚îÄ‚îÄ RefreshTokenRepository.java    ‚Üê T·ª´ feature branch
‚îÇ   ‚îî‚îÄ‚îÄ VerificationRepository.java    ‚Üê ƒê√£ merge (clean imports)
‚îú‚îÄ‚îÄ dto/
‚îÇ   ‚îú‚îÄ‚îÄ LoginDTO.java
‚îÇ   ‚îú‚îÄ‚îÄ GoogleLoginDTO.java
‚îÇ   ‚îú‚îÄ‚îÄ FacebookLoginDTO.java
‚îÇ   ‚îú‚îÄ‚îÄ AuthTokenResponse.java
‚îÇ   ‚îú‚îÄ‚îÄ RefreshTokenRequest.java
‚îÇ   ‚îî‚îÄ‚îÄ JwtResponse.java
‚îî‚îÄ‚îÄ util/
    ‚îî‚îÄ‚îÄ TokenProvider.java
```

---

### **Phase 3: Refactor User Module (Files ƒë√£ merge)**

#### 3.1. UserController.java & UserService.java
**From:** `controller/UserController.java`, `service/UserService.java`  
**To:** `user/controller/UserController.java`, `user/service/UserService.java`

```bash
# T·∫°o c·∫•u tr√∫c User module
mkdir -p Ecommerce/src/main/java/com/PBL6/Ecommerce/user/controller
mkdir -p Ecommerce/src/main/java/com/PBL6/Ecommerce/user/service
mkdir -p Ecommerce/src/main/java/com/PBL6/Ecommerce/user/domain
mkdir -p Ecommerce/src/main/java/com/PBL6/Ecommerce/user/repository
mkdir -p Ecommerce/src/main/java/com/PBL6/Ecommerce/user/dto

# Di chuy·ªÉn Controllers (ƒë√£ merge v·ªõi Admin APIs + Rate limiting)
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/controller/UserController.java Ecommerce/src/main/java/com/PBL6/Ecommerce/user/controller/
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/controller/ForgotPasswordController.java Ecommerce/src/main/java/com/PBL6/Ecommerce/user/controller/

# Di chuy·ªÉn Services (ƒë√£ merge v·ªõi Admin services + OTP security)
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/service/UserService.java Ecommerce/src/main/java/com/PBL6/Ecommerce/user/service/
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/service/ForgotPasswordService.java Ecommerce/src/main/java/com/PBL6/Ecommerce/user/service/

# Di chuy·ªÉn Domain
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/domain/User.java Ecommerce/src/main/java/com/PBL6/Ecommerce/user/domain/
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/domain/Role.java Ecommerce/src/main/java/com/PBL6/Ecommerce/user/domain/

# Di chuy·ªÉn Repository
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/repository/UserRepository.java Ecommerce/src/main/java/com/PBL6/Ecommerce/user/repository/

# Di chuy·ªÉn DTOs (User-related)
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/domain/dto/UserInfoDTO.java Ecommerce/src/main/java/com/PBL6/Ecommerce/user/dto/
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/domain/dto/RegisterDTO.java Ecommerce/src/main/java/com/PBL6/Ecommerce/user/dto/
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/domain/dto/CheckContactDTO.java Ecommerce/src/main/java/com/PBL6/Ecommerce/user/dto/
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/domain/dto/VerifyOtpDTO.java Ecommerce/src/main/java/com/PBL6/Ecommerce/user/dto/
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/domain/dto/ForgotPasswordDTO.java Ecommerce/src/main/java/com/PBL6/Ecommerce/user/dto/
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/domain/dto/ResetPasswordDTO.java Ecommerce/src/main/java/com/PBL6/Ecommerce/user/dto/
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/domain/dto/AdminUserDetailDTO.java Ecommerce/src/main/java/com/PBL6/Ecommerce/user/dto/
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/domain/dto/ListAdminUserDTO.java Ecommerce/src/main/java/com/PBL6/Ecommerce/user/dto/
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/domain/dto/ListSellerUserDTO.java Ecommerce/src/main/java/com/PBL6/Ecommerce/user/dto/
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/domain/dto/ListCustomerUserDTO.java Ecommerce/src/main/java/com/PBL6/Ecommerce/user/dto/
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/domain/dto/UpdateUserRoleDTO.java Ecommerce/src/main/java/com/PBL6/Ecommerce/user/dto/
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/domain/dto/UpdateUserStatusDTO.java Ecommerce/src/main/java/com/PBL6/Ecommerce/user/dto/
```

**Thay ƒë·ªïi package trong UserController.java:**

```java
package com.PBL6.Ecommerce.user.controller;

import com.PBL6.Ecommerce.user.dto.AdminUserDetailDTO;
import com.PBL6.Ecommerce.user.dto.CheckContactDTO;
import com.PBL6.Ecommerce.user.dto.RegisterDTO;
import com.PBL6.Ecommerce.user.dto.UpdateUserRoleDTO;
import com.PBL6.Ecommerce.user.dto.UpdateUserStatusDTO;
import com.PBL6.Ecommerce.user.dto.UserInfoDTO;
import com.PBL6.Ecommerce.user.dto.VerifyOtpDTO;
import com.PBL6.Ecommerce.user.service.UserService;
import com.PBL6.Ecommerce.common.dto.ResponseDTO;
import com.PBL6.Ecommerce.security.service.LoginAttemptService; // ‚Üê Cross-module dependency
// ... rest of imports

@RestController
@RequestMapping("/api")
public class UserController {
    // ... (gi·ªØ nguy√™n logic ƒë√£ merge: Admin APIs + Rate limiting)
}
```

**‚ö†Ô∏è L∆∞u √Ω quan tr·ªçng trong UserService.java sau refactor:**

```java
package com.PBL6.Ecommerce.user.service;

import com.PBL6.Ecommerce.user.domain.User;
import com.PBL6.Ecommerce.user.domain.Role;
import com.PBL6.Ecommerce.user.repository.UserRepository;
import com.PBL6.Ecommerce.user.dto.*;
import com.PBL6.Ecommerce.security.domain.Verification;
import com.PBL6.Ecommerce.security.repository.VerificationRepository;
import com.PBL6.Ecommerce.security.service.LoginAttemptService; // ‚Üê Cross-module
import com.PBL6.Ecommerce.cart.domain.Cart;                     // ‚Üê Cross-module
import com.PBL6.Ecommerce.cart.repository.CartRepository;       // ‚Üê Cross-module
import com.PBL6.Ecommerce.cart.repository.CartItemRepository;   // ‚Üê Cross-module
import com.PBL6.Ecommerce.shop.domain.Shop;                     // ‚Üê Cross-module
import com.PBL6.Ecommerce.shop.repository.ShopRepository;       // ‚Üê Cross-module
import com.PBL6.Ecommerce.product.repository.ProductRepository; // ‚Üê Cross-module
import com.PBL6.Ecommerce.notification.service.EmailService;    // ‚Üê Infrastructure
import com.PBL6.Ecommerce.notification.service.SmsService;      // ‚Üê Infrastructure

@Service
public class UserService {
    // Constructor ƒë√£ merge v·ªõi ƒë·∫ßy ƒë·ªß dependencies
    public UserService(
        UserRepository userRepository,
        VerificationRepository verificationRepository,
        PasswordEncoder passwordEncoder,
        EmailService emailService,
        SmsService smsService,
        LoginAttemptService loginAttemptService,
        CartRepository cartRepository,
        CartItemRepository cartItemRepository,
        ShopRepository shopRepository,
        ProductRepository productRepository
    ) {
        // ...
    }
    
    // ... (gi·ªØ nguy√™n logic ƒë√£ merge: Admin services + OTP security + Rate limiting)
}
```

**C·∫•u tr√∫c User Module sau refactor:**
```
user/
‚îú‚îÄ‚îÄ controller/
‚îÇ   ‚îú‚îÄ‚îÄ UserController.java            ‚Üê ƒê√£ merge (Admin APIs + Rate limiting)
‚îÇ   ‚îî‚îÄ‚îÄ ForgotPasswordController.java
‚îú‚îÄ‚îÄ service/
‚îÇ   ‚îú‚îÄ‚îÄ UserService.java               ‚Üê ƒê√£ merge (Admin + OTP + dependencies)
‚îÇ   ‚îî‚îÄ‚îÄ ForgotPasswordService.java
‚îú‚îÄ‚îÄ domain/
‚îÇ   ‚îú‚îÄ‚îÄ User.java
‚îÇ   ‚îî‚îÄ‚îÄ Role.java
‚îú‚îÄ‚îÄ repository/
‚îÇ   ‚îî‚îÄ‚îÄ UserRepository.java
‚îî‚îÄ‚îÄ dto/
    ‚îú‚îÄ‚îÄ UserInfoDTO.java               ‚Üê ‚ö†Ô∏è C·∫ßn fix constructor (5 params)
    ‚îú‚îÄ‚îÄ RegisterDTO.java
    ‚îú‚îÄ‚îÄ CheckContactDTO.java
    ‚îú‚îÄ‚îÄ VerifyOtpDTO.java
    ‚îú‚îÄ‚îÄ ForgotPasswordDTO.java
    ‚îú‚îÄ‚îÄ ResetPasswordDTO.java
    ‚îú‚îÄ‚îÄ AdminUserDetailDTO.java        ‚Üê T·ª´ main branch
    ‚îú‚îÄ‚îÄ ListAdminUserDTO.java          ‚Üê T·ª´ main branch
    ‚îú‚îÄ‚îÄ ListSellerUserDTO.java         ‚Üê T·ª´ main branch
    ‚îú‚îÄ‚îÄ ListCustomerUserDTO.java       ‚Üê T·ª´ main branch
    ‚îú‚îÄ‚îÄ UpdateUserRoleDTO.java         ‚Üê T·ª´ main branch
    ‚îî‚îÄ‚îÄ UpdateUserStatusDTO.java       ‚Üê T·ª´ main branch
```

---

### **Phase 4: T·∫°o Common Module (Shared Components)**

```bash
# T·∫°o c·∫•u tr√∫c Common module
mkdir -p Ecommerce/src/main/java/com/PBL6/Ecommerce/common/dto
mkdir -p Ecommerce/src/main/java/com/PBL6/Ecommerce/common/exception
mkdir -p Ecommerce/src/main/java/com/PBL6/Ecommerce/common/util

# Di chuy·ªÉn Shared DTO
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/domain/dto/ResponseDTO.java Ecommerce/src/main/java/com/PBL6/Ecommerce/common/dto/

# Di chuy·ªÉn GlobalExceptionHandler
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/controller/GlobalExceptionHandler.java Ecommerce/src/main/java/com/PBL6/Ecommerce/common/exception/
```

**T·∫°o c√°c exception classes m·ªõi:**

```java
// common/exception/BusinessException.java
package com.PBL6.Ecommerce.common.exception;

public class BusinessException extends RuntimeException {
    private final int statusCode;
    
    public BusinessException(String message) {
        this(400, message);
    }
    
    public BusinessException(int statusCode, String message) {
        super(message);
        this.statusCode = statusCode;
    }
    
    public int getStatusCode() {
        return statusCode;
    }
}

// common/exception/ResourceNotFoundException.java
package com.PBL6.Ecommerce.common.exception;

public class ResourceNotFoundException extends BusinessException {
    public ResourceNotFoundException(String resource, Long id) {
        super(404, resource + " v·ªõi ID " + id + " kh√¥ng t·ªìn t·∫°i");
    }
}

// common/exception/UnauthorizedException.java
package com.PBL6.Ecommerce.common.exception;

public class UnauthorizedException extends BusinessException {
    public UnauthorizedException(String message) {
        super(401, message);
    }
}

// common/exception/ValidationException.java
package com.PBL6.Ecommerce.common.exception;

public class ValidationException extends BusinessException {
    public ValidationException(String message) {
        super(400, message);
    }
}

// common/exception/RateLimitException.java
package com.PBL6.Ecommerce.common.exception;

public class RateLimitException extends BusinessException {
    public RateLimitException(String message) {
        super(429, message);
    }
}
```

**C·∫•u tr√∫c Common Module:**
```
common/
‚îú‚îÄ‚îÄ dto/
‚îÇ   ‚îî‚îÄ‚îÄ ResponseDTO.java               ‚Üê Shared response wrapper
‚îú‚îÄ‚îÄ exception/
‚îÇ   ‚îú‚îÄ‚îÄ GlobalExceptionHandler.java    ‚Üê Centralized error handling
‚îÇ   ‚îú‚îÄ‚îÄ BusinessException.java         ‚Üê Base exception
‚îÇ   ‚îú‚îÄ‚îÄ ResourceNotFoundException.java ‚Üê 404 errors
‚îÇ   ‚îú‚îÄ‚îÄ UnauthorizedException.java     ‚Üê 401 errors
‚îÇ   ‚îú‚îÄ‚îÄ ValidationException.java       ‚Üê 400 errors
‚îÇ   ‚îî‚îÄ‚îÄ RateLimitException.java        ‚Üê 429 errors
‚îî‚îÄ‚îÄ util/
    ‚îú‚îÄ‚îÄ DateUtils.java                 ‚Üê Date utilities (t·∫°o m·ªõi n·∫øu c·∫ßn)
    ‚îî‚îÄ‚îÄ StringUtils.java               ‚Üê String utilities (t·∫°o m·ªõi n·∫øu c·∫ßn)
```

---

### **Phase 5: Refactor Product & Category Module**

```bash
# T·∫°o c·∫•u tr√∫c Product module
mkdir -p Ecommerce/src/main/java/com/PBL6/Ecommerce/product/controller
mkdir -p Ecommerce/src/main/java/com/PBL6/Ecommerce/product/service
mkdir -p Ecommerce/src/main/java/com/PBL6/Ecommerce/product/domain
mkdir -p Ecommerce/src/main/java/com/PBL6/Ecommerce/product/repository
mkdir -p Ecommerce/src/main/java/com/PBL6/Ecommerce/product/dto

# Di chuy·ªÉn Controllers
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/controller/ProductController.java Ecommerce/src/main/java/com/PBL6/Ecommerce/product/controller/
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/controller/CategoryController.java Ecommerce/src/main/java/com/PBL6/Ecommerce/product/controller/

# Di chuy·ªÉn Services
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/service/ProductService.java Ecommerce/src/main/java/com/PBL6/Ecommerce/product/service/
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/service/CategoryService.java Ecommerce/src/main/java/com/PBL6/Ecommerce/product/service/

# Di chuy·ªÉn Domain entities
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/domain/Product.java Ecommerce/src/main/java/com/PBL6/Ecommerce/product/domain/
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/domain/ProductAttribute.java Ecommerce/src/main/java/com/PBL6/Ecommerce/product/domain/
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/domain/ProductVariant.java Ecommerce/src/main/java/com/PBL6/Ecommerce/product/domain/
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/domain/ProductVariantValue.java Ecommerce/src/main/java/com/PBL6/Ecommerce/product/domain/
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/domain/ProductImage.java Ecommerce/src/main/java/com/PBL6/Ecommerce/product/domain/
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/domain/Category.java Ecommerce/src/main/java/com/PBL6/Ecommerce/product/domain/

# Di chuy·ªÉn Repositories
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/repository/ProductRepository.java Ecommerce/src/main/java/com/PBL6/Ecommerce/product/repository/
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/repository/ProductAttributeRepository.java Ecommerce/src/main/java/com/PBL6/Ecommerce/product/repository/
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/repository/ProductVariantRepository.java Ecommerce/src/main/java/com/PBL6/Ecommerce/product/repository/
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/repository/ProductImageRepository.java Ecommerce/src/main/java/com/PBL6/Ecommerce/product/repository/
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/repository/CategoryRepository.java Ecommerce/src/main/java/com/PBL6/Ecommerce/product/repository/

# Di chuy·ªÉn DTOs
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/domain/dto/ProductDTO.java Ecommerce/src/main/java/com/PBL6/Ecommerce/product/dto/
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/domain/dto/ProductCreateDTO.java Ecommerce/src/main/java/com/PBL6/Ecommerce/product/dto/
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/domain/dto/ProductVariantDTO.java Ecommerce/src/main/java/com/PBL6/Ecommerce/product/dto/
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/domain/dto/ProductVariantValueDTO.java Ecommerce/src/main/java/com/PBL6/Ecommerce/product/dto/
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/domain/dto/ProductImageDTO.java Ecommerce/src/main/java/com/PBL6/Ecommerce/product/dto/
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/domain/dto/CategoryDTO.java Ecommerce/src/main/java/com/PBL6/Ecommerce/product/dto/
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/domain/dto/AttributeDTO.java Ecommerce/src/main/java/com/PBL6/Ecommerce/product/dto/
```

---

### **Phase 6: T·∫°o Notification Module (Infrastructure)**

```bash
# T·∫°o c·∫•u tr√∫c Notification module
mkdir -p Ecommerce/src/main/java/com/PBL6/Ecommerce/notification/service

# Di chuy·ªÉn Infrastructure services
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/service/EmailService.java Ecommerce/src/main/java/com/PBL6/Ecommerce/notification/service/
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/service/SmsService.java Ecommerce/src/main/java/com/PBL6/Ecommerce/notification/service/
```

**Thay ƒë·ªïi package:**

```java
package com.PBL6.Ecommerce.notification.service;

import org.springframework.stereotype.Service;

@Service
public class EmailService {
    // ... (gi·ªØ nguy√™n logic)
}
```

---

### **Phase 7: T·∫°o Shop & Order Modules (Future)**

```bash
# Shop module (ready for implementation)
mkdir -p Ecommerce/src/main/java/com/PBL6/Ecommerce/shop/controller
mkdir -p Ecommerce/src/main/java/com/PBL6/Ecommerce/shop/service
mkdir -p Ecommerce/src/main/java/com/PBL6/Ecommerce/shop/domain
mkdir -p Ecommerce/src/main/java/com/PBL6/Ecommerce/shop/repository
mkdir -p Ecommerce/src/main/java/com/PBL6/Ecommerce/shop/dto

# Order module (ready for implementation)
mkdir -p Ecommerce/src/main/java/com/PBL6/Ecommerce/order/controller
mkdir -p Ecommerce/src/main/java/com/PBL6/Ecommerce/order/service
mkdir -p Ecommerce/src/main/java/com/PBL6/Ecommerce/order/domain
mkdir -p Ecommerce/src/main/java/com/PBL6/Ecommerce/order/repository
mkdir -p Ecommerce/src/main/java/com/PBL6/Ecommerce/order/dto

# Di chuy·ªÉn Shop entities
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/domain/Shop.java Ecommerce/src/main/java/com/PBL6/Ecommerce/shop/domain/
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/repository/ShopRepository.java Ecommerce/src/main/java/com/PBL6/Ecommerce/shop/repository/
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/service/ShopService.java Ecommerce/src/main/java/com/PBL6/Ecommerce/shop/service/
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/controller/ShopController.java Ecommerce/src/main/java/com/PBL6/Ecommerce/shop/controller/
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/domain/dto/ShopRegistrationDTO.java Ecommerce/src/main/java/com/PBL6/Ecommerce/shop/dto/

# Di chuy·ªÉn Order entities (ch∆∞a implement)
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/domain/Order.java Ecommerce/src/main/java/com/PBL6/Ecommerce/order/domain/
git mv Ecommerce/src/main/java/com/PBL6/Ecommerce/domain/OrderItem.java Ecommerce/src/main/java/com/PBL6/Ecommerce/order/domain/
```

---

## üìù **Checklist Refactoring (Theo th·ª© t·ª±)**

### ‚úÖ **Tr∆∞·ªõc khi refactor:**
- [ ] Commit t·∫•t c·∫£ changes hi·ªán t·∫°i
- [ ] T·∫°o branch m·ªõi: `git checkout -b refactor/module-based-architecture`
- [ ] Run tests (n·∫øu c√≥) ƒë·ªÉ ƒë·∫£m b·∫£o code ƒëang OK
- [ ] Backup database (n·∫øu c·∫ßn)

### ‚úÖ **Phase 1: Cart Module (3-4 ng√†y)**
- [ ] T·∫°o c·∫•u tr√∫c folders: `cart/controller`, `cart/service`, `cart/domain`, `cart/repository`, `cart/dto`
- [ ] Di chuy·ªÉn CartController.java
- [ ] Di chuy·ªÉn CartService.java
- [ ] Di chuy·ªÉn Cart.java, CartItem.java
- [ ] Di chuy·ªÉn CartRepository.java, CartItemRepository.java
- [ ] Di chuy·ªÉn 4 Cart DTOs
- [ ] Update package declarations
- [ ] Update imports trong t·∫•t c·∫£ files
- [ ] Compile: `./mvnw clean compile`
- [ ] Run tests
- [ ] Test APIs v·ªõi Postman
- [ ] Commit: `git commit -m "Refactor: Extract cart module"`

### ‚úÖ **Phase 2: Common Module (1 ng√†y)**
- [ ] T·∫°o `common/dto`, `common/exception`, `common/util`
- [ ] Di chuy·ªÉn ResponseDTO.java
- [ ] Di chuy·ªÉn GlobalExceptionHandler.java
- [ ] T·∫°o BusinessException.java
- [ ] T·∫°o ResourceNotFoundException.java
- [ ] T·∫°o UnauthorizedException.java
- [ ] T·∫°o ValidationException.java
- [ ] T·∫°o RateLimitException.java
- [ ] Update imports ·ªü t·∫•t c·∫£ modules
- [ ] Compile & test
- [ ] Commit: `git commit -m "Refactor: Create common module with exceptions"`

### ‚úÖ **Phase 3: Security Module (5-7 ng√†y)**
- [ ] T·∫°o c·∫•u tr√∫c folders: `security/config`, `security/controller`, `security/service`, etc.
- [ ] Di chuy·ªÉn SecurityConfig.java (ƒë√£ merge)
- [ ] Di chuy·ªÉn 5 Auth controllers
- [ ] Di chuy·ªÉn 7 Auth services
- [ ] Di chuy·ªÉn RefreshToken.java, Verification.java (ƒë√£ merge)
- [ ] Di chuy·ªÉn 2 repositories (ƒë√£ merge)
- [ ] Di chuy·ªÉn 6 Auth DTOs
- [ ] Di chuy·ªÉn TokenProvider.java
- [ ] Update all packages & imports
- [ ] Compile & test authentication flow
- [ ] Test login, logout, refresh token
- [ ] Test rate limiting
- [ ] Commit: `git commit -m "Refactor: Extract security module"`

### ‚úÖ **Phase 4: User Module (1 tu·∫ßn)**
- [ ] T·∫°o c·∫•u tr√∫c folders: `user/controller`, `user/service`, etc.
- [ ] Di chuy·ªÉn UserController.java (ƒë√£ merge v·ªõi Admin APIs + Rate limiting)
- [ ] Di chuy·ªÉn ForgotPasswordController.java
- [ ] Di chuy·ªÉn UserService.java (ƒë√£ merge v·ªõi ƒë·∫ßy ƒë·ªß dependencies)
- [ ] Di chuy·ªÉn ForgotPasswordService.java
- [ ] Di chuy·ªÉn User.java, Role.java
- [ ] Di chuy·ªÉn UserRepository.java
- [ ] Di chuy·ªÉn 12 User DTOs
- [ ] **‚ö†Ô∏è Fix UserInfoDTO constructor calls (5 parameters)**
- [ ] Update all packages & imports
- [ ] Compile & test
- [ ] Test Admin APIs
- [ ] Test user registration with OTP
- [ ] Test forgot password flow
- [ ] Commit: `git commit -m "Refactor: Extract user module"`

### ‚úÖ **Phase 5: Product Module (1 tu·∫ßn)**
- [ ] T·∫°o c·∫•u tr√∫c folders
- [ ] Di chuy·ªÉn ProductController.java, CategoryController.java
- [ ] Di chuy·ªÉn ProductService.java, CategoryService.java
- [ ] Di chuy·ªÉn 6 Product entities
- [ ] Di chuy·ªÉn 5 repositories
- [ ] Di chuy·ªÉn 7 Product DTOs
- [ ] Update all packages & imports
- [ ] Compile & test
- [ ] Test product CRUD
- [ ] Test category APIs
- [ ] Commit: `git commit -m "Refactor: Extract product module"`

### ‚úÖ **Phase 6: Notification Module (2 ng√†y)**
- [ ] T·∫°o `notification/service`
- [ ] Di chuy·ªÉn EmailService.java
- [ ] Di chuy·ªÉn SmsService.java
- [ ] Update imports
- [ ] Compile & test
- [ ] Commit: `git commit -m "Refactor: Extract notification module"`

### ‚úÖ **Phase 7: Shop & Order Modules (3-4 ng√†y)**
- [ ] T·∫°o c·∫•u tr√∫c shop module
- [ ] Di chuy·ªÉn Shop entities, service, controller
- [ ] T·∫°o c·∫•u tr√∫c order module (ready for implementation)
- [ ] Di chuy·ªÉn Order.java, OrderItem.java
- [ ] Update imports
- [ ] Compile & test
- [ ] Commit: `git commit -m "Refactor: Extract shop & order modules"`

### ‚úÖ **Final Steps:**
- [ ] Run full test suite
- [ ] Test t·∫•t c·∫£ APIs v·ªõi Postman
- [ ] Update README.md v·ªõi c·∫•u tr√∫c m·ªõi
- [ ] Update API documentation
- [ ] Merge v√†o main: `git checkout main && git merge refactor/module-based-architecture`
- [ ] Deploy & monitor

---

## üéØ **C·∫•u Tr√∫c Cu·ªëi C√πng Sau Refactoring**

```
src/main/java/com/PBL6/Ecommerce/
‚îÇ
‚îú‚îÄ‚îÄ EcommerceApplication.java
‚îÇ
‚îú‚îÄ‚îÄ common/                        ‚úÖ Shared components
‚îÇ   ‚îú‚îÄ‚îÄ dto/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ResponseDTO.java
‚îÇ   ‚îú‚îÄ‚îÄ exception/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ GlobalExceptionHandler.java
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ BusinessException.java
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ResourceNotFoundException.java
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ UnauthorizedException.java
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ValidationException.java
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ RateLimitException.java
‚îÇ   ‚îî‚îÄ‚îÄ util/
‚îÇ
‚îú‚îÄ‚îÄ security/                      ‚úÖ Auth & Security (files ƒë√£ merge)
‚îÇ   ‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ SecurityConfig.java   ‚Üê ƒê√£ merge
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ WebConfig.java
‚îÇ   ‚îú‚îÄ‚îÄ controller/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AuthController.java
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ GoogleAuthController.java
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ FacebookAuthController.java
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ RefreshTokenController.java
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ LogoutController.java
‚îÇ   ‚îú‚îÄ‚îÄ service/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AuthService.java
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ GoogleAuthService.java
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ FacebookAuthService.java
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ RefreshTokenService.java
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ TokenBlacklistService.java
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ LoginAttemptService.java
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ TokenCleanupScheduler.java
‚îÇ   ‚îú‚îÄ‚îÄ domain/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ RefreshToken.java
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Verification.java     ‚Üê ƒê√£ merge
‚îÇ   ‚îú‚îÄ‚îÄ repository/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ RefreshTokenRepository.java
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ VerificationRepository.java ‚Üê ƒê√£ merge
‚îÇ   ‚îú‚îÄ‚îÄ dto/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ... (6 Auth DTOs)
‚îÇ   ‚îî‚îÄ‚îÄ util/
‚îÇ       ‚îî‚îÄ‚îÄ TokenProvider.java
‚îÇ
‚îú‚îÄ‚îÄ user/                          ‚úÖ User Management (files ƒë√£ merge)
‚îÇ   ‚îú‚îÄ‚îÄ controller/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ UserController.java   ‚Üê ƒê√£ merge (Admin + Rate limiting)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ForgotPasswordController.java
‚îÇ   ‚îú‚îÄ‚îÄ service/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ UserService.java      ‚Üê ƒê√£ merge (Admin + OTP + deps)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ForgotPasswordService.java
‚îÇ   ‚îú‚îÄ‚îÄ domain/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ User.java
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Role.java
‚îÇ   ‚îú‚îÄ‚îÄ repository/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ UserRepository.java
‚îÇ   ‚îî‚îÄ‚îÄ dto/
‚îÇ       ‚îî‚îÄ‚îÄ ... (12 User DTOs)    ‚Üê ‚ö†Ô∏è Fix UserInfoDTO constructor
‚îÇ
‚îú‚îÄ‚îÄ cart/                          ‚úÖ Shopping Cart
‚îÇ   ‚îú‚îÄ‚îÄ controller/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ CartController.java
‚îÇ   ‚îú‚îÄ‚îÄ service/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ CartService.java
‚îÇ   ‚îú‚îÄ‚îÄ domain/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Cart.java
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ CartItem.java
‚îÇ   ‚îú‚îÄ‚îÄ repository/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CartRepository.java
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ CartItemRepository.java
‚îÇ   ‚îî‚îÄ‚îÄ dto/
‚îÇ       ‚îî‚îÄ‚îÄ ... (4 Cart DTOs)
‚îÇ
‚îú‚îÄ‚îÄ product/                       ‚úÖ Product & Category
‚îÇ   ‚îú‚îÄ‚îÄ controller/
‚îÇ   ‚îú‚îÄ‚îÄ service/
‚îÇ   ‚îú‚îÄ‚îÄ domain/
‚îÇ   ‚îú‚îÄ‚îÄ repository/
‚îÇ   ‚îî‚îÄ‚îÄ dto/
‚îÇ
‚îú‚îÄ‚îÄ shop/                          ‚úÖ Shop/Vendor
‚îÇ   ‚îú‚îÄ‚îÄ controller/
‚îÇ   ‚îú‚îÄ‚îÄ service/
‚îÇ   ‚îú‚îÄ‚îÄ domain/
‚îÇ   ‚îú‚îÄ‚îÄ repository/
‚îÇ   ‚îî‚îÄ‚îÄ dto/
‚îÇ
‚îú‚îÄ‚îÄ order/                         ‚úÖ Order Management (ready for impl)
‚îÇ   ‚îú‚îÄ‚îÄ controller/
‚îÇ   ‚îú‚îÄ‚îÄ service/
‚îÇ   ‚îú‚îÄ‚îÄ domain/
‚îÇ   ‚îú‚îÄ‚îÄ repository/
‚îÇ   ‚îî‚îÄ‚îÄ dto/
‚îÇ
‚îî‚îÄ‚îÄ notification/                  ‚úÖ Infrastructure
    ‚îî‚îÄ‚îÄ service/
        ‚îú‚îÄ‚îÄ EmailService.java
        ‚îî‚îÄ‚îÄ SmsService.java
```

---

## ‚ö†Ô∏è **L∆∞u √ù Quan Tr·ªçng Khi Refactor**

### 1. **Cross-Module Dependencies**
Sau khi refactor, m·ªôt s·ªë modules s·∫Ω ph·ª• thu·ªôc l·∫´n nhau:

```java
// UserService ph·ª• thu·ªôc Cart module
import com.PBL6.Ecommerce.cart.repository.CartRepository;

// UserService ph·ª• thu·ªôc Security module
import com.PBL6.Ecommerce.security.service.LoginAttemptService;

// CartService ph·ª• thu·ªôc User module
import com.PBL6.Ecommerce.user.domain.User;

// CartService ph·ª• thu·ªôc Product module
import com.PBL6.Ecommerce.product.domain.ProductVariant;
```

**Gi·∫£i ph√°p:** ƒê√¢y l√† NORMAL trong module-based architecture. Mi·ªÖn l√† kh√¥ng c√≥ circular dependency.

### 2. **UserInfoDTO Constructor Fix**
**PH·∫¢I FIX tr∆∞·ªõc khi refactor User module:**

```java
// ‚ùå SAI - 3 v·ªã tr√≠ trong UserService.java
new UserInfoDTO(user.getId(), user.getEmail(), user.getUsername(), user.getRole().name())

// ‚úÖ ƒê√öNG
new UserInfoDTO(user.getId(), user.getEmail(), user.getUsername(), user.getPhoneNumber(), user.getRole().name())
```

### 3. **Application.properties**
**KH√îNG DI CHUY·ªÇN** file n√†y. Gi·ªØ nguy√™n trong `resources/` v·ªõi config ƒë√£ merge.

### 4. **Testing Strategy**
Sau m·ªói phase refactor:
1. Compile: `./mvnw clean compile`
2. Run tests: `./mvnw test` (n·∫øu c√≥)
3. Test APIs b·∫±ng Postman
4. Commit ngay ƒë·ªÉ d·ªÖ rollback

### 5. **Git Strategy**
```bash
# T·∫°o branch refactor
git checkout -b refactor/module-based-architecture

# Sau m·ªói phase
git add .
git commit -m "Refactor Phase X: Module name"

# N·∫øu c√≥ v·∫•n ƒë·ªÅ
git reset --hard HEAD~1  # Rollback 1 commit

# Khi ho√†n th√†nh
git checkout main
git merge refactor/module-based-architecture
```

---

## üìä **Timeline ∆Ø·ªõc T√≠nh**

| Phase | Module | Duration | Risk Level |
|-------|--------|----------|------------|
| 0 | Preparation | 1 ng√†y | Low |
| 1 | Cart | 3-4 ng√†y | Low |
| 2 | Common | 1 ng√†y | Low |
| 3 | Security | 5-7 ng√†y | Medium |
| 4 | User | 1 tu·∫ßn | Medium |
| 5 | Product | 1 tu·∫ßn | Medium |
| 6 | Notification | 2 ng√†y | Low |
| 7 | Shop & Order | 3-4 ng√†y | Low |
| **TOTAL** | | **3-4 tu·∫ßn** | Incremental |

---

## ‚úÖ **Success Criteria**

Refactoring th√†nh c√¥ng khi:
- [ ] T·∫•t c·∫£ tests pass
- [ ] T·∫•t c·∫£ APIs ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng
- [ ] Kh√¥ng c√≥ circular dependencies
- [ ] Code compile without errors
- [ ] Application starts successfully
- [ ] Documentation updated
- [ ] Team members reviewed & approved

---

**üìå L∆∞u √Ω:** File b√°o c√°o n√†y ƒë∆∞·ª£c t·∫°o t·ª± ƒë·ªông ƒë·ªÉ tracking qu√° tr√¨nh merge. Gi·ªØ file n√†y trong repository ƒë·ªÉ tham kh·∫£o sau n√†y.
